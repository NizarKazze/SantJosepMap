<!-- Contenedor del mapa -->
<div id="mapContent" style="display:flex;flex-wrap:wrap;">
  <div id="filter" style="flex:1 1 300px;max-width:300px;padding:10px;">
    <div class="maptitle">
      <h1>Sant Josep Map</h1>
    </div>
    <div class="btnGroup">
      <div id="btnGeoloc">
        <div class="img-container">
          <img src="https://www.santjosep.net/wp-content/uploads/2025/09/geolocicon-e1758531188961.png" alt="ubicación">
        </div>
        <div class="textContent">
          <h3>Cerca de mí</h3>
          <p>Se solicitará permiso.</p>
        </div>
      </div>
      <div id="selectMapView">
        <div id="btnShowFilter">
          <div class="img-container">
            <img src="https://www.santjosep.net/wp-content/uploads/2025/09/listIcon-e1758537294910.png" alt="">
          </div>
          <h3>Ver Lista</h3>
        </div>
        <div id="btnShowMap">
          <div class="img-container">
            <img src="https://www.santjosep.net/wp-content/uploads/2025/09/mapIcon-e1758537997275.png" alt="">
          </div>
          <h3>Mapa</h3>
        </div>
      </div>
    </div>
    <div class="filterTitle">
      <div class="filterContainer">
        <div class="img-container">
          <img src="https://www.santjosep.net/wp-content/uploads/2025/09/filtericon-e1758532062691.png" alt="filtro">
        </div>
        <div class="textContent">
          <h2>FILTROS</h2>
        </div>
      </div>
      <button id="filterCloseBtn">
        <p>Cerrar</p>
        <img src="https://www.santjosep.net/wp-content/uploads/2025/09/closeicon-e1758535460246.png" alt="">
      </button>
    </div>
    <div id="selectLocation" class="selectLocation">
      <div class="title-container">
        <h2>CATEGORIÁS</h2>
      </div>
      <div id="categoryBtnGroup">
        <button value="">Todos</button>
        <button value="playas">Playas</button>
        <button value="iglesias">Iglesias</button>
        <button value="museos">Museos</button>
        <button value="torres">Torres</button>
        <button value="patrimonio">Patrimonio</button>
        <button value="pueblos">Pueblos</button>
      </div>
      <div class="divider"></div>
      <div id="searchContainer">
        <h2>BÚSQUEDA</h2>
        <div id="SearchinputContainer">
          <div class="SearchImg">
            <img src="https://www.santjosep.net/wp-content/uploads/2025/09/lupaicon-e1758529228860.png" alt="">
          </div>
          <input type="text" id="searchInput" placeholder="buscar..." />
        </div>
      </div>

    </div>
    <div id="filterResults"></div>
  </div>
  <div id="map" style="width: 100%"></div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="style.css">

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- JSON Data -->
<script src="https://www.santjosep.net/wp-content/themes/atmosphere-child/js/mapdata.js"></script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const isMobile = window.innerWidth <= 768;
  const map = L.map('map').setView([38.900444, 1.327944], isMobile ? 11 : 13);

L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://www.carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);


  
  map.whenReady(function () {
    setTimeout(function () {
      map.invalidateSize();
    }, 300);
  });

  let markers = [];
  let userMarker = null;

  data.features.forEach(point => {
    const coords = point.geometry.coordinates;
    const props = point.properties;

    if (props.type == "zone"){
      createZone(point);

    } else {
      let marker = L.marker([coords[1], coords[0]], { icon: getIconByCategory(props.category) })
      .bindPopup(popupTemplate(point))
      .addTo(map);

      marker.category = props.category;
      marker.pointData = point;
      markers.push(marker);
    }


  });
  
  // ============ Coordenadas zonas =========

  function createZone(feature) {
    var polygon = L.geoJSON(feature, {
      style: {
        color: '#3388ff',
        fillColor: '#3388ff',
        opacity: 0.4,
        fillOpacity: 0.4
      }
    }).addTo(map);

    polygon.eachLayer(function(layer) {
      layer.category = feature.properties.category;
    });
  }

  function getPolygonCenter(feature) {
    if (feature.geometry.type !== "Polygon") {
      console.warn("El feature no es un polígono");
      return null;
    }

    let coords = feature.geometry.coordinates[0];
    let sumLat = 0, sumLng = 0;

    coords.forEach(c => {
      sumLng += c[0];
      sumLat += c[1];
    });

    let lat = sumLat / coords.length;
    let lng = sumLng / coords.length;

    return [lat, lng];
  }



    function getIconByCategory(category) {
      // Define los íconos personalizados por categoría
      let icons = {
        playas: "https://www.santjosep.net/wp-content/uploads/2025/09/playasIcon-e1758621854784.png",
        museos: "img/icons/museo.png",
        iglesias: "https://www.santjosep.net/wp-content/uploads/2025/09/iglesiasIcon-e1758705821671.png",
        torres: "img/icons/torre.png",
        patrimonio: "img/icons/patrimonio.png",
        defaulticon: "https://www.santjosep.net/wp-content/uploads/2025/09/location-e1758621917999.png"
      };
      
      let size = isMobile ? [22, 22] : [38, 38];
    
      return L.icon({
        iconUrl: icons[category] || icons["defaulticon"],
        iconSize: size,
        iconAnchor: [size[0] / 2, size[1] / 2],
        popupAnchor: [0, -size[1] / 2],
        shadowUrl: null
      });
    }


  function getColorByCategory(category) {
    const categoryColors = {
      'playas': '#2FACB2',
      'museos': '#ef4444',
      'iglesias': '#8b5cf6',
      'torres': '#f59e0b',
      'patrimonio': '#374151'
    };
    return categoryColors[category] || '#6b7280';
  }

  // ========== Templates ============

  function popupTemplate(point) {
    return `
      <div class="popupContainer">
        <div class="popupImg">
          <img class="popupImage" src="${point.properties.image || 'https://via.placeholder.com/150x100?text=Sin+imagen'}" alt="${point.properties.name}">
        </div>
        <div class="popupContent">
          <h3 class="popupTitle">${point.properties.name}</h3>
          <p class="popupDesc">${point.properties.description}</p>
          ${point.properties.website ? `<a class="websiteLink" href="${point.properties.website}" target="_blank" rel="noopener noreferrer">Visitar Página</a>` : ''}
        </div>
      </div>
    `;
  }

  function searchResultTemplate(point, categoryColor) {
    const filterResults = document.getElementById('filterResults');
    let divContainer = document.createElement('div');
    divContainer.classList.add('resultItem', 'clickable-item');

    let imgContainer = document.createElement('div');
    imgContainer.classList.add('imgContainer');

    let imgEl = document.createElement('img');
    imgEl.classList.add('resultImage');
    imgEl.src = point.properties.image || "https://via.placeholder.com/300x180?text=Sin+imagen";
    imgEl.alt = point.properties.name;

    let categoryTag = document.createElement('span');
    categoryTag.classList.add('categoryTag');
    categoryTag.textContent = point.properties.category;
    categoryTag.style.backgroundColor = categoryColor || getColorByCategory(point.properties.category);

    imgContainer.appendChild(imgEl);
    imgContainer.appendChild(categoryTag);

    let resultTitle = document.createElement('h3');
    resultTitle.classList.add('resultTitle');
    resultTitle.textContent = point.properties.name;

    let resultDesc = document.createElement('p');
    resultDesc.classList.add('resultDesc');
    resultDesc.textContent = point.properties.description;

    let websiteLink = document.createElement('a');
    websiteLink.classList.add('websiteLink');
    websiteLink.href = point.properties.url || "#";
    websiteLink.textContent = 'Visitar Página';
    websiteLink.rel = 'noopener noreferrer';

    divContainer.appendChild(imgContainer);
    divContainer.appendChild(resultTitle);
    divContainer.appendChild(resultDesc);
    divContainer.appendChild(websiteLink);

    if (point.properties.type == "zone"){
      divContainer.addEventListener("click", function (e) {
        if (e.target.tagName !== 'A') {
          let polygonLayer = L.geoJSON(point).addTo(map);
          map.fitBounds(polygonLayer.getBounds());
        }
      });
      
    } else {
      divContainer.addEventListener("click", function(e) {
        if (e.target.tagName !== 'A') {
          const coords = point.geometry.coordinates;
          map.setView([coords[1], coords[0]]); 
          const marker = markers.find(m => m.pointData === point);
          if (marker) marker.openPopup();
        }
      });
    }


    

    filterResults.appendChild(divContainer);
  }

  // ============= FILTER BY INPUT ===================

  let UserInput = "";
  const SearchInput = document.getElementById("searchInput");
  
  SearchInput.addEventListener("input", (e) => {
    UserInput = e.target.value.toLowerCase();
    SearchByUserInput(UserInput);
  });

  function SearchByUserInput(input) {
    let filterContent = document.querySelectorAll('.resultItem');

    const normalizedInput = input
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, "");

    const pattern = new RegExp(normalizedInput, "i");

    filterContent.forEach(resultItem => {
      const itemName = resultItem.querySelector('.resultTitle').textContent
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "");

      if (!pattern.test(itemName)) {
        resultItem.style.display = 'none';
      } else {
        resultItem.style.display = 'flex';
      }
    });
  }

  // ============== FILTER BY CATEGORY ===============

  const categoryBtn = document.querySelectorAll('#selectLocation button');
  categoryBtn.forEach(button => {
    button.addEventListener('click', () => {
      filtro(button.value);
      categoryBtn.forEach(btn => {
        btn.style.backgroundColor = "";
        btn.style.color = "";
      });

        button.style.backgroundColor = "#FCA01F";
        button.style.color = "white";
      });
  });

  function filtro(category) {
    const filterResults = document.getElementById('filterResults');
    filterResults.innerHTML = "";

    markers.forEach(marker => {
      if (!category || marker.category === category) {
        map.addLayer(marker);
      } else {
        map.removeLayer(marker);
      }
    });

    data.features.forEach(point => {
      if (!category || point.properties.category === category) {
        const categoryColor = getColorByCategory(point.properties.category);
        searchResultTemplate(point, categoryColor);
      }
    });
  }

  // ========= GEOLOCATION ===========

  document.getElementById('btnGeoloc').addEventListener('click', () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        if (userMarker) map.removeLayer(userMarker);

        userMarker = L.marker([lat, lon], {
          icon: L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
            iconSize: [30, 30]
          })
        }).addTo(map).bindPopup("Estás aquí").openPopup();

        map.setView([lat, lon], 14);
      }, err => {
        alert("No se pudo obtener la ubicación");
      });
    } else {
      alert("La geolocalización no está soportada en este navegador.");
    }
  });

  document.getElementById('selectLocation').addEventListener('change', filtro);
  filtro();
  
  // ============ RESPONSIVE =============

  const btnShowFilter = document.getElementById('btnShowFilter');
  const btnShowMap = document.getElementById('btnShowMap');
  const mapContainer = document.getElementById('map');
  const filterResultsContainer = document.getElementById('filterResults');

  btnShowFilter.addEventListener('click', () => {
    mapContainer.style.display = 'none';
    filterResultsContainer.style.display = 'block';
    btnShowMap.style.display = 'flex';
    btnShowFilter.style.display = 'none';
  });
 
  btnShowMap.addEventListener('click', () => {
    filterResultsContainer.style.display = 'none';
    mapContainer.style.display = 'block';
    btnShowMap.style.display = 'none';
    btnShowFilter.style.display = 'flex';
    setTimeout(() => map.invalidateSize(), 300);
  });

  if (window.innerWidth > 999) {
    btnShowFilter.style.display = "none";
    btnShowMap.style.display = "none";

  }

  const filterTitle = document.querySelector('.filterContainer');
  const filterbtn = document.getElementById('filterCloseBtn');
  const selectLocation = document.getElementById('selectLocation');
  let isOpen = false;

  filterTitle.addEventListener('click', () => {
    if (window.innerWidth < 999) {
      if (!isOpen) {
        // Abrir
        selectLocation.style.transition = 'height 0.5s ease, padding 0.5s ease';
        selectLocation.style.height = '375px';
        selectLocation.style.padding = '30px';
        filterbtn.style.display = "flex"
        isOpen = true;
      } else {
        // Cerrar
        selectLocation.style.transition = 'height 0.5s ease, padding 0.5s ease';
        selectLocation.style.height = '0px';
        selectLocation.style.padding = '0 30px';
        filterbtn.style.display = "none"
        isOpen = false;
      }
    }
  });

  filterbtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if (isOpen) {
      selectLocation.style.transition = 'height 0.5s ease, padding 0.5s ease';
      selectLocation.style.height = '0px';
      selectLocation.style.padding = '0 30px';
      filterbtn.style.display = "none"
      isOpen = false;
    }
  });

  window.addEventListener('resize', function () {
    map.invalidateSize();
  });
});
</script>
