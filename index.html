<!-- Contenedor del mapa -->
<div id="mapContent" style="display:flex;flex-wrap:wrap;">
  <div id="filter" style="flex:1 1 300px;max-width:300px;padding:10px;">
    <div class="maptitle">
      <h1>Sant Josep Map</h1>
    </div>
    <div class="btnGroup">
      <button id="btnShowFilter" class='mapbtn'>Resultado Filtro</button>
      <button id="btnShowMap" class='mapbtn'>Mapa</button>
      <div id="btnGeoloc">
        <div class="img-container">
          <img src="https://www.santjosep.net/wp-content/uploads/2025/09/geolocicon-e1758531188961.png" alt="ubicación">
        </div>
        <div class="textContent">
          <h3>Cerca de mí</h3>
          <p>Se solicitará permiso.</p>
        </div>
      </div>
    </div>
    <div class="filterTitle">
      <div class="img-container">
        <img src="https://www.santjosep.net/wp-content/uploads/2025/09/filtericon-e1758532062691.png" alt="filtro">
      </div>
      <div class="textContent">
        <h2>FILTROS</h2>
      </div>
    </div>
    <div id="selectLocation">
      <div class="title-container">
        <h2>CATEGORIÁS</h2>
      </div>
      <div id="categoryBtnGroup">
        <button value="">Todos</button>
        <button value="playas">Playas</button>
        <button value="iglesias">Iglesias</button>
        <button value="museos">Museos</button>
        <button value="torres">Torres</button>
        <button value="patrimonio">Patrimonio</button>
        <button value="pueblos">Pueblos</button>
      </div>
      <div class="divider"></div>
      <div id="searchContainer">
        <h2>BÚSQUEDA</h2>
        <div id="SearchinputContainer">
          <div class="SearchImg">
            <img src="https://www.santjosep.net/wp-content/uploads/2025/09/lupaicon-e1758529228860.png" alt="">
          </div>
          <input type="text" id="searchInput" placeholder="buscar..." />
        </div>
      </div>

    </div>
    <div id="filterResults"></div>
  </div>
  <div id="map" style="width: 100%"></div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="style.css">

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- JSON Data -->
<script src="https://www.santjosep.net/wp-content/themes/atmosphere-child/js/mapdata.js"></script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const isMobile = window.innerWidth <= 768;
  const map = L.map('map').setView([38.900444, 1.327944], isMobile ? 11 : 13);
  var base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

  
  map.whenReady(function () {
    setTimeout(function () {
      map.invalidateSize();
    }, 300);
  });

  let markers = [];
  let userMarker = null;

  data.features.forEach(point => {
    const coords = point.geometry.coordinates;
    const props = point.properties;

    if (props.type == "zone"){
      createZone(point);

    } else {
      let marker = L.marker([coords[1], coords[0]], { icon: getIconByCategory(props.category) })
      .bindPopup(popupTemplate(point))
      .addTo(map);

      marker.category = props.category;
      marker.pointData = point;
      markers.push(marker);
    }


  });
  
  // ============ Coordenadas zonas =========

  function createZone(feature) {
    var polygon = L.geoJSON(feature, {
      style: {
        color: '#3388ff',
        fillColor: '#3388ff',
        opacity: 0.4,
        fillOpacity: 0.4
      }
    }).addTo(map);

    polygon.eachLayer(function(layer) {
      layer.category = feature.properties.category;
    });
  }

  function getPolygonCenter(feature) {
    if (feature.geometry.type !== "Polygon") {
      console.warn("El feature no es un polígono");
      return null;
    }

    let coords = feature.geometry.coordinates[0];
    let sumLat = 0, sumLng = 0;

    coords.forEach(c => {
      sumLng += c[0];
      sumLat += c[1];
    });

    let lat = sumLat / coords.length;
    let lng = sumLng / coords.length;

    return [lat, lng];
  }



  function getIconByCategory(category) {
    let color = "blue";
    if (category === "playas") color = "green";
    if (category === "museos") color = "red";
    if (category === "iglesias") color = "orange";
    if (category === "torres") color = "violet";
    if (category === "patrimonio") color = "black";

    return L.icon({
      iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
      shadowUrl: "https://unpkg.com/leaflet/dist/images/marker-shadow.png",
      iconSize: isMobile ? [16, 28] : [25, 41],
      iconAnchor: isMobile ? [10, 33] : [12, 41],
      popupAnchor: [1, -34],
      shadowSize: isMobile ? [20, 20] : [41, 41]
    });
  }

  function getColorByCategory(category) {
    const categoryColors = {
      'playas': '#10b981',
      'museos': '#ef4444',
      'iglesias': '#f59e0b',
      'torres': '#8b5cf6',
      'patrimonio': '#374151'
    };
    return categoryColors[category] || '#6b7280';
  }

  // ========== Templates ============

  function popupTemplate(point) {
    return `
      <div class="popupContainer">
        <div class="popupImg">
          <img class="popupImage" src="${point.properties.image || 'https://via.placeholder.com/150x100?text=Sin+imagen'}" alt="${point.properties.name}">
        </div>
        <div class="popupContent">
          <h3 class="popupTitle">${point.properties.name}</h3>
          <p class="popupDesc">${point.properties.description}</p>
          ${point.properties.website ? `<a class="websiteLink" href="${point.properties.website}" target="_blank" rel="noopener noreferrer">Visitar Página</a>` : ''}
        </div>
      </div>
    `;
  }

  function searchResultTemplate(point, categoryColor) {
    const filterResults = document.getElementById('filterResults');
    let divContainer = document.createElement('div');
    divContainer.classList.add('resultItem', 'clickable-item');

    let imgContainer = document.createElement('div');
    imgContainer.classList.add('imgContainer');

    let imgEl = document.createElement('img');
    imgEl.classList.add('resultImage');
    imgEl.src = point.properties.image || "https://via.placeholder.com/300x180?text=Sin+imagen";
    imgEl.alt = point.properties.name;

    let categoryTag = document.createElement('span');
    categoryTag.classList.add('categoryTag');
    categoryTag.textContent = point.properties.category;
    categoryTag.style.backgroundColor = categoryColor || getColorByCategory(point.properties.category);

    imgContainer.appendChild(imgEl);
    imgContainer.appendChild(categoryTag);

    let resultTitle = document.createElement('h3');
    resultTitle.classList.add('resultTitle');
    resultTitle.textContent = point.properties.name;

    let resultDesc = document.createElement('p');
    resultDesc.classList.add('resultDesc');
    resultDesc.textContent = point.properties.description;

    let websiteLink = document.createElement('a');
    websiteLink.classList.add('websiteLink');
    websiteLink.href = point.properties.url || "#";
    websiteLink.textContent = 'Visitar Página';
    websiteLink.rel = 'noopener noreferrer';

    divContainer.appendChild(imgContainer);
    divContainer.appendChild(resultTitle);
    divContainer.appendChild(resultDesc);
    divContainer.appendChild(websiteLink);

    if (point.properties.type == "zone"){
      divContainer.addEventListener("click", function (e) {
        if (e.target.tagName !== 'A') {
          let polygonLayer = L.geoJSON(point).addTo(map);
          map.fitBounds(polygonLayer.getBounds());
        }
      });
      
    } else {
      divContainer.addEventListener("click", function(e) {
        if (e.target.tagName !== 'A') {
          const coords = point.geometry.coordinates;
          map.setView([coords[1], coords[0]]); 
          const marker = markers.find(m => m.pointData === point);
          if (marker) marker.openPopup();
        }
      });
    }


    

    filterResults.appendChild(divContainer);
  }

  // ============= FILTER BY INPUT ===================

  let UserInput = "";
  const SearchInput = document.getElementById("searchInput");
  
  SearchInput.addEventListener("input", (e) => {
    UserInput = e.target.value.toLowerCase();
    SearchByUserInput(UserInput);
  });

  function SearchByUserInput(input) {
    let filterContent = document.querySelectorAll('.resultItem');

    const normalizedInput = input
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, "");

    const pattern = new RegExp(normalizedInput, "i");

    filterContent.forEach(resultItem => {
      const itemName = resultItem.querySelector('.resultTitle').textContent
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "");

      if (!pattern.test(itemName)) {
        resultItem.style.display = 'none';
      } else {
        resultItem.style.display = 'flex';
      }
    });
  }

  // ============== FILTER BY CATEGORY ===============

  const categoryBtn = document.querySelectorAll('#selectLocation button');
  categoryBtn.forEach(button => {
    button.addEventListener('click', () => {
      filtro(button.value);
      categoryBtn.forEach(btn => {
        btn.style.backgroundColor = "";
      });

      button.style.backgroundColor = "#FCA01F";
      });
  });

  function filtro(category) {
    const filterResults = document.getElementById('filterResults');
    filterResults.innerHTML = "";

    markers.forEach(marker => {
      if (!category || marker.category === category) {
        map.addLayer(marker);
      } else {
        map.removeLayer(marker);
      }
    });

    data.features.forEach(point => {
      if (!category || point.properties.category === category) {
        const categoryColor = getColorByCategory(point.properties.category);
        searchResultTemplate(point, categoryColor);
      }
    });
  }

  // ========= GEOLOCATION ===========

  document.getElementById('btnGeoloc').addEventListener('click', () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        if (userMarker) map.removeLayer(userMarker);

        userMarker = L.marker([lat, lon], {
          icon: L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
            iconSize: [30, 30]
          })
        }).addTo(map).bindPopup("Estás aquí").openPopup();

        map.setView([lat, lon], 14);
      }, err => {
        alert("No se pudo obtener la ubicación");
      });
    } else {
      alert("La geolocalización no está soportada en este navegador.");
    }
  });

  document.getElementById('selectLocation').addEventListener('change', filtro);
  filtro();
  
  // ============ RESPONSIVE =============

  const btnShowFilter = document.getElementById('btnShowFilter');
  const btnShowMap = document.getElementById('btnShowMap');
  const mapContainer = document.getElementById('map');
  const filterResultsContainer = document.getElementById('filterResults');

  btnShowFilter.addEventListener('click', () => {
    mapContainer.style.display = 'none';
    filterResultsContainer.style.display = 'block';
  });
 
  btnShowMap.addEventListener('click', () => {
    filterResultsContainer.style.display = 'none';
    mapContainer.style.display = 'block';
    setTimeout(() => map.invalidateSize(), 300);
  });
 
  window.addEventListener('resize', function () {
    map.invalidateSize();
  });
});
</script>
